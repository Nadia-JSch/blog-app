---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const tilPosts = await getCollection('til');
  const notesPosts = await getCollection('coding-notes');

  const allPosts = [
    ...tilPosts.map((p) => ({ ...p, section: 'til' as const })),
    ...notesPosts.map((p) => ({ ...p, section: 'coding-notes' as const })),
  ];

  const tags = [...new Set(allPosts.flatMap((p) => p.data.tags ?? []))];

  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: allPosts
        .filter((p) => p.data.tags?.includes(tag))
        .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`#${tag} - pg of code`}>
  <header class="page-header">
    <h1>#{tag}</h1>
    <p>{posts.length} post{posts.length !== 1 ? 's' : ''} tagged with "{tag}"</p>
  </header>

  <div class="post-list">
    {posts.map((post: any) => (
      <PostCard
        title={post.data.title}
        date={post.data.date}
        description={post.data.description}
        url={`/${post.section}/${post.id}`}
        tags={post.data.tags}
      />
    ))}
  </div>
</BaseLayout>

<style>
  .page-header {
    margin-bottom: 2.5rem;
  }

  .page-header h1 {
    font-size: 2.2rem;
    color: var(--text-heading);
    margin-bottom: 0.5rem;
  }

  .page-header p {
    color: var(--text-light);
    font-size: 1.05rem;
  }

  .post-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>
